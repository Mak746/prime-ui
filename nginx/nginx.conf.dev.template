
user nginx nginx;
worker_processes  4;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events { worker_connections  1024;}

http {
        log_format  main    '$remote_addr - $remote_user [$time_local] "$request" '
                            '$status $body_bytes_sent "$http_referer" '
                            '"$http_user_agent" "$http_x_forwarded_for"';
        access_log          /var/log/nginx/access.log  main;

        proxy_cache_path        /var/cache/nginx levels=1:2 keys_zone=one:8m max_size=3000m inactive=600m;
        proxy_temp_path         /var/tmp;
        include                 mime.types;
        default_type            application/octet-stream;
        sendfile                on;
        keepalive_timeout       65;
        server_tokens           off;
        
        gzip                    on;
        gzip_comp_level         6;
        gzip_vary               on;
        gzip_min_length         1000;
        gzip_proxied            any;
        gzip_types              text/plain text/css  application/javascript application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
        gzip_buffers            16 8k;


       

        # -------------
        # admin
        # -------------
        server {
          listen 80;
          server_name  localhost 10.*;
           location /images/ {
              alias /usr/share/nginx/html/images/;
              gzip_static on;
              expires max;
              add_header Cache-Control public;
            }

            location /chats/ {
              alias /usr/share/nginx/html/chats/;
              gzip_static on; 
              expires max; 
              add_header Cache-Control public;
            }
        }


        server {
          listen 4200;
          server_name  localhost:4200 10.*;
          location /images/ {
            alias /usr/share/nginx/html/images/;
            gzip_static on;
            expires max;
            add_header Cache-Control public;
          }
          location / {
              proxy_pass http://alhamdu-admin:4200/;
              proxy_http_version 1.1;
              proxy_set_header Host               $host;
              proxy_set_header X-Real-IP          $remote_addr;
              proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto  $scheme;
          }
          location ~* ^\/images\/(.+\.(jpg|jpeg|gif|mp3|png|ico|css|zip|tgz|gz|rar|bz2|pdf|txt|tar|wav|bmp|rtf|js|flv|swf|html|htm))$ {
              root /usr/share/nginx/html/images;
              try_files $1 $1/ =404;
          }
        }

  

        # -------------
        # landing
        # -------------
        server {
          listen 4202;
          server_name  localhost:4202 10.*;
          location /images/ {
            alias /usr/share/nginx/html/images/;
            gzip_static on;
            expires max;
            add_header Cache-Control public;
          }
          location / {
              proxy_pass http://alhamdu-landing:4202/;
              proxy_http_version 1.1;
              proxy_set_header Host               $host;
              proxy_set_header X-Real-IP          $remote_addr;
              proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto  $scheme;
          }
          location ~* ^\/images\/(.+\.(jpg|jpeg|gif|mp3|png|ico|css|zip|tgz|gz|rar|bz2|pdf|txt|tar|wav|bmp|rtf|js|flv|swf|html|htm))$ {
              root /usr/share/nginx/html/images;
              try_files $1 $1/ =404;
          }
        }

 

        # -------------
        # backend
        # -------------

        # List of backend api services
        upstream api_servers {
            server alhamdu-api:3000;
        }

        # -----------
        # api
        # -----------
        server {
          listen 3000;
          server_name  localhost 10.*;
          location /api {

              proxy_http_version  1.1;
              proxy_set_header    Upgrade $http_upgrade;
              proxy_set_header    Connection 'upgrade';
              proxy_set_header    Host $host;
              proxy_set_header    X-Forwarded-For $remote_addr;  # this line
              proxy_set_header    X-Forwarded-Proto  $scheme;
              proxy_cache_bypass  $http_upgrade; 

              # THESE ARE IMPORTANT
              proxy_set_header    X-Real-IP       $remote_addr;
              proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;

              # This is what tells Connect that your session can be considered secure, 
              # even though the protocol node.js sees is only HTTP:

              proxy_set_header      X-NginX-Proxy true;
              proxy_read_timeout    5m;
              proxy_connect_timeout 5m;
              proxy_redirect        off;

              proxy_set_header Cookie $http_cookie;

              # proxy headers
              proxy_headers_hash_max_size     512;
              proxy_headers_hash_bucket_size  128;        

              proxy_pass          http://api_servers/api;

          }
         
        }

        # -----------
        # adminer
        # -----------
        server {
          listen 8085;
          server_name  localhost 10.*;

          location / {
              proxy_pass http://alhamdu-adminer:8085/;
              proxy_http_version 1.1;
              proxy_set_header Host               $host;
              proxy_set_header X-Real-IP          $remote_addr;
              proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto  $scheme;
          }
        }

    

}
